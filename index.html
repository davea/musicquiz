<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Spotify Music Quiz</title>
    <style>
        body {
            font-family: system-ui, sans-serif;
            margin: 0;
            padding: 1em;
            background-color: black;
            color: silver;
        }

        a, a:visited {
            text-decoration: none;
            color: white;
        }

        #playlists {
            list-style: none;
            padding: 0;
            margin: 0;
            position: relative;
        }
        #playlists li {
            margin: 1em 0;
            float: left;
        }

        #choices {
            list-style: none;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: row;
        }

        #choices li {
            padding: 1em;
            margin: 1em;
            flex: 1;
            box-shadow: 0 0 10px #f0f;
            text-align: center;
            cursor: pointer;
            min-width: 0;
        }

        #choices li img {
            max-width: 100%;
            object-fit: contain;
        }

        #choices li:hover {
            box-shadow: 0 0 15px #0ff;
        }

        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <section class="hidden playlists">
        <h1>Choose a playlist</h1>
        <ul id="playlists"></ul>
    </section>

    <section class="hidden quiz">
        <a id="clear_playlist" href="#">&larr; Choose a playlist</a>
        <h1></h1>

        <audio id="preview" autoplay loop controls></audio>

        <ul id="choices"></ul>
    </section>

    <script type="text/javascript">
        // (() => {

        const client_id = '4f23cdad03ba4bdda4098bc19df5f53a';

        function spotify_fetch(url) {
            const token = localStorage.getItem('token');
            if (!token) {
                return refresh_token();
            }
            if (!url.startsWith("https://")) {
                url = "https://api.spotify.com" + url;
            }
            return fetch(
                url,
                {
                    method: "GET",
                    headers: {
                        Authorization: "Bearer " + token,
                        Accept: "application/json"
                    }
                }
            )
            .then(response => {
                if (response.status != 200) {
                    return refresh_token();
                } else {
                    return response.json();
                }
            });
        }

        function refresh_token() {
            window.location.hash = '';
            var scope = 'user-read-private playlist-read-private user-library-read user-follow-read';
            var login_url = 'https://accounts.spotify.com/authorize?client_id=' + client_id
                    + '&redirect_uri=' + encodeURIComponent(window.location.href)
                    + '&scope=' + encodeURIComponent(scope)
                    + '&response_type=token';
            window.location.href = login_url;
        }

        function display_section(section) {
            for (const el of document.getElementsByTagName("section")) {
                if (el.classList.contains(section)) {
                    el.classList.remove("hidden");
                } else {
                    el.classList.add("hidden");
                }
            }
        }

        function show_playlists() {
            display_section("playlists");
            load_playlists().then(playlists => {
                playlists.forEach(add_playlist_item);
            });
        }

        function load_playlists(url, playlists) {
            url = url || "/v1/me/playlists";
            playlists = playlists || [];

            return spotify_fetch(url).then(({items, next}) => {
                if (next) {
                    return load_playlists(next, playlists.concat(items));
                } else {
                    return new Promise(resolve => {
                        resolve(playlists);
                    });
                }
            })
        }

        function add_playlist_item({name, uri, images, tracks: {href: tracks_url}}) {
            var ul = document.getElementById("playlists");
            var li = document.createElement("li");
            if (images && images.length) {
                var img = document.createElement("img");
                img.src = images[0].url;
                img.height = 300;
                img.width = 300;
                img.title = name;
                li.appendChild(img);
            }
            li.addEventListener("click", () => {
                select_playlist(name, tracks_url);
            })
            ul.appendChild(li);
        }

        function select_playlist(name, tracks) {
            localStorage.setItem("playlist_tracks", tracks);
            localStorage.setItem("playlist_name", name);
            location.reload();
        }

        function start_quiz() {
            display_section("quiz");
            document.querySelector("#clear_playlist").addEventListener("click", e => {
                e.preventDefault();
                localStorage.removeItem("playlist_tracks");
                localStorage.removeItem("playlist_name");
                location.reload();
            })
            document.querySelector("section.quiz h1").textContent = localStorage.getItem("playlist_name");
            load_playlist(localStorage.getItem("playlist_tracks")).then(tracks => {
                play_a_round(tracks);
            });
        }

        function play_a_round(tracks) {
            console.log(tracks.length);
            const choices = sample(tracks, 3);
            console.log(choices);
            display_choices(choices);
        }

        function display_choices(choices) {
            const ul = document.getElementById("choices");
            const correct = sample(choices, 1)[0];
            const render_item = sample([
                render_item_track_name,
                render_item_artist_names,
                render_item_artwork,
            ], 1)[0];

            for (const choice of choices) {
                const li = render_item(choice);
                li.addEventListener("click", () => {
                    choice_made(choice, choice === correct);
                });
                ul.appendChild(li);
            }
            play_preview(correct.preview_url);
        }

        function render_item_track_name(track) {
            const li = document.createElement("li");
            li.textContent = track.name;
            return li;
        }

        function render_item_artist_names(track) {
            const li = document.createElement("li");
            li.textContent = track.artists.map(artist => artist.name).join(", ");
            return li;
        }

        function render_item_artwork(track) {
            if (!track.album.images.length) {
                console.log("No images for track.", track);
                return render_item_track_name(track);
            }
            const li = document.createElement("li");
            const img = document.createElement("img");
            img.src = track.album.images[0].url;
            li.appendChild(img);
            return li;
        }

        function choice_made(choice, correct) {
            console.log(correct ? "CORRECT!" : "Nope :(");
            setTimeout(() => { location.reload() }, 1000);
        }

        function load_playlist(url, tracks) {
            tracks = tracks || [];
            return spotify_fetch(url).then(({items, next}) => {
                items.forEach(({track}) => {
                    if (track.preview_url) {
                        tracks.push(track);
                    }
                });
                if (next) {
                    return load_playlist(next, tracks);
                } else {
                    return new Promise(resolve => {
                        resolve(tracks);
                    })
                }
            })
        }

        function add_track({preview_url, album, uri, name}) {
            if (!preview_url) {
                return;
            }
            var ul = document.getElementById("tracks");
            var li = document.createElement("li");
            li.textContent = name;
            li.addEventListener("click", () => {
                console.log(album);
                play_preview(preview_url);
            })
            ul.appendChild(li);
        }

        function play_preview(preview_url) {
            console.log(preview_url);
            const audio = document.querySelector("audio#preview");
            // audio.pause();
            audio.src = preview_url;
            // audio.play();
        }

        function handle_auth_callback() {
            var hash = parse_hash();
            if (hash.access_token) {
                localStorage.setItem('token', hash.access_token);
            }
        }

        function parse_hash() {
            var hash = {};
            location.hash.replace(/^#\/?/, '').split('&').forEach(function(kv) {
                var spl = kv.indexOf('=');
                if (spl != -1) {
                    hash[kv.substring(0, spl)] = decodeURIComponent(kv.substring(spl+1));
                }
            });
            location.hash = '';
            return hash;
        }

        function sample(population, k) {
            const chosen = new Set([]);
            while (chosen.size < k) {
                chosen.add(population[Math.floor(Math.random() * Math.floor(population.length))]);
            }
            return Array.from(chosen);
        }

        document.addEventListener("DOMContentLoaded", () => {
            if (!!window.location.hash) {
                handle_auth_callback();
            }
            if (!localStorage.getItem("playlist_tracks")) {
                show_playlists();
            } else {
                start_quiz();
            }
        });

        // })();
    </script>
</body>
</html>
